name: sync-nextgen

on:
  push:
    branches:
      - "feat/restructure"

concurrency:
  group: sync-nextgen
  cancel-in-progress: true

permissions:
  contents: write
  actions: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge feat/restructure into preview-nextgen
        env:
          SOURCE_BRANCH: "feat/restructure"
          TARGET_BRANCH: "preview-nextgen"
        run: |
          set -euo pipefail

          git fetch origin "${SOURCE_BRANCH}" --prune
          git fetch origin "${TARGET_BRANCH}" --prune || true

          if git show-ref --verify --quiet "refs/remotes/origin/${TARGET_BRANCH}"; then
            git switch -c "${TARGET_BRANCH}" "origin/${TARGET_BRANCH}" || git switch "${TARGET_BRANCH}"
          else
            # Create the target branch the first time if it doesn't exist yet.
            git switch -c "${TARGET_BRANCH}" "origin/${SOURCE_BRANCH}"
          fi

          git merge --no-ff "origin/${SOURCE_BRANCH}" -m "sync-nextgen: merge ${SOURCE_BRANCH} into ${TARGET_BRANCH}"
          git push origin "${TARGET_BRANCH}"

      - name: Dispatch production workflow on preview-nextgen
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "production.yml",
              ref: "preview-nextgen",
              inputs: {
                hash: "nextgen",
              },
            });
